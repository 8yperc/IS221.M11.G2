--1. Tìm khách hàng hủy đặt phòng nhưng không đặt lại.
SELECT KH.MaKH, TenKH
FROM KHACHHANG_QL KH JOIN DATPHONG DP ON KH.MaKH = DP.MaKH
MINUS
SELECT KH.MaKH, TenKH
FROM KHACHHANG_QL KH JOIN DATPHONG DP ON KH.MaKH = DP.MaKH
WHERE TrangThaiDat = 'Dat thanh cong'
MINUS
SELECT KH.MaKH, TenKH
FROM KHACHHANG_QL KH JOIN DATPHONG DP ON KH.MaKH = DP.MaKH
WHERE TrangThaiDat = 'Dat truoc';



--2. Thống kê tổng số dịch vụ khách hàng sử dụng ở mỗi lần đặt phòng.
SELECT MaKH, DP.MaDatPhong, COUNT(MaKH) AS SoDichVu
FROM DATPHONG DP, CHITIETDICHVU CT
WHERE CT.MaDatPhong = DP.MaDatPhong
GROUP BY MaKH, DP.MaDatPhong
ORDER BY MaKH, SoDichVu DESC;



--3. Thống kê tần suất các dịch vụ được gọi theo số lần từ cao đến thấp.
SELECT D.MaDV, TenDV, COUNT(D.MaDV) AS SoLanGoi
FROM DICHVU D JOIN CHITIETDICHVU CT ON D.MaDV = CT.MaDV
GROUP BY D.MaDV, TenDV
ORDER BY SoLanGoi DESC;



--4. Cho biết tần suất các phòng được đặt theo chi nhánh.
SELECT P.MaPhong, LoaiPhong, CN.MaCN, COUNT(P.MaPhong) AS TanSuat
FROM PHONG P, DATPHONG DP, CHINHANH CN
WHERE P.MaPhong = DP.MaPhong
AND CN.MaCN = P.MaCN
GROUP BY P.MaPhong, LoaiPhong, CN.MaCN
ORDER BY CN.MaCN, TanSuat DESC;




--5. Tìm khách hàng đặt phòng thành công ở cả hai chi nhánh.
SELECT KH.MAKH, KH.TenKH, KH.DiaChi
FROM KHACHHANG KH
WHERE MAKH IN ( SELECT DP.MAKH
                FROM DATPHONG DP
                WHERE DP.MaKH = KH.MaKH 
                AND NOT EXISTS (SELECT * 
                                FROM CHINHANH CN
                                WHERE NOT EXISTS(
                                SELECT *
                                FROM (  SELECT *
                                        FROM DATPHONG DP JOIN PHONG P
                                        ON DP.MaPhong = P.MaPhong) A
                                        WHERE A.MaKH=KH.MaKH 
                                        AND A.MaCN = CN.MaCN 
                                        AND A.TrangThaiDat = 'Dat thanh cong')));